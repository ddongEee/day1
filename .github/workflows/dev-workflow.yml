name: dev-workflow
on:
  push:
    branches: ['*']
defaults:
  run:
    shell: bash

env:
  RUNNABLE_PKG_NAME: "."
  BUILD_FILE_NAME: "build.gradle"
  COMMON_INCLUDES: "gradle.properties, *.gradle, Dockerfile.app.build"
  # Runtime Versions of Applications
  GRADLE_VERSION: "7.5"
  JAVA_VERSION: "11"
  YQ_VERSION: "v4.27.2"
  # Runtime Versions of Containers
  COMPOSE_VERSION: "v2.9.0"
  BASE_ECR_IMAGE_NAME: day1-base-spring
  BASE_ECR_IMAGE_VERS: "0.1.0"
  # GitOps: Integration target of 'git branches'
  GITOPS_REPO_NAME: day1

jobs:
  build:
    runs-on: [ HRA-control, dockerd ]
    env:
      ECR_REPO_PREFIX: day1
    steps:
      - name: ðŸš€ [INIT] Clone repository
        uses: actions/checkout@v3

      # ------------------------------
      # > Set: AWS
      # ------------------------------
      - name: ðŸš€ [AWS] Assume using IRSA # Ref. https://github.com/aws-actions/configure-aws-credentials#self-hosted-runners
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: "ap-northeast-2"
          role-to-assume: "SHARED-EKS-self-hosted-runner" # Federated IAM Role name
          role-session-name: "SHARED-EKS-self-hosted-runner"
          role-duration-seconds: "3600"
          web-identity-token-file: "/var/run/secrets/eks.amazonaws.com/serviceaccount/token"
      
      # ------------------------------
      # > Set: Docker
      # ------------------------------
      - name: ðŸš€ [SET] Docker - enable chache layer
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-multi-buildx-${{ hashFiles('docker-compose.yml') }}
          restore-keys: |
            ${{ runner.os }}-multi-buildx-

      - name: ðŸš€ [SET] Docker - check 'docker-compose'
        shell: bash
        run: docker-compose --version

      - name: ðŸš€ [SET] Login to Amazon ECR
        id: ecr-login
        uses: aws-actions/amazon-ecr-login@v1

      - name: ðŸš€ [GRADLE/JVM] Install java
        uses: actions/setup-java@v3
        with:
          distribution: "corretto" # Ref. https://github.com/actions/setup-java#supported-distributions
          java-version: ${{ env.JAVA_VERSION }}
          architecture: x64
          check-latest: true
          cache: 'gradle'

      - name: ðŸš€ [GRADLE/JVM] Check java
        shell: bash
        run: java --version

      - name: ðŸš€ [GRADLE/JVM] Pull gradle cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('settings.gradle', 'build.gradle', 'gradle/wrapper/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸš€ [GRADLE] Check wrapper dependencies
        shell: bash
        run: |
          echo "Generating the Wrapper files requires an installed version of the Gradle runtime on runner"
          chmod +x ./gradlew && ./gradlew wrapper
